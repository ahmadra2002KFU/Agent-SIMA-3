<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>AI Sima - Chat with your data</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#0D47A1", // A deep blue from the logo
                        "background-light": "#F0F4F8",
                        "background-dark": "#121212",
                        "surface-light": "#FFFFFF",
                        "surface-dark": "#1E1E1E",
                        "text-light": "#1A202C",
                        "text-dark": "#E2E8F0",
                        "accent-red": "#D32F2F", // Red from the crescent
                    },
                    fontFamily: {
                        display: ["Sora", "sans-serif"],
                    },
                    borderRadius: {
                        'DEFAULT': '0.75rem',
                        'lg': '1rem',
                        'xl': '1.5rem',
                    },
                },
            },
        };
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL'0,
            'wght'400,
            'GRAD'0,
            'opsz'24
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-light dark:text-text-dark transition-colors duration-300">
<div class="flex h-screen">
<aside class="w-72 bg-surface-light dark:bg-surface-dark p-6 flex flex-col justify-between shadow-lg">
<div>
<div class="flex items-center space-x-3 mb-6">
<img alt="AI Sima Logo" class="h-10 w-10" src="https://lh3.googleusercontent.com/aida-public/AB6AXuDuSNLNpEYFMZvVPOYUV4sj0KwCU1vUPANL83NjRSPupaOL2kXwecZ6r6-BUSVcfo4sPmZOKeGBek73nugAtAcg49yMCAAy76Y0_k3t_oAn_Aki-07BYeXmL0mGvr8BM0LirbrtDQoX6oj-SU2fLv4BXGV4-o_cZKTqcwwqKjK8PUOUO4CRkCny8xqD9-_4jvsjpOTYollB8AEgZB4kxMm5YlvSWciP_4JKVoR8x4Aw0AQ-D870c6rWDRdvskNixrs1szIMPFSWqg74"/>
<h1 class="text-2xl font-bold text-primary dark:text-white">AI Sima</h1>
</div>
<div class="mb-6 p-4 bg-background-light dark:bg-gray-700/50 rounded-lg">
<h3 class="text-sm font-semibold text-gray-600 dark:text-gray-300 mb-3 flex items-center">
<span class="material-symbols-outlined mr-2 text-base">description</span>
                        File Info
                    </h3>
<div class="text-xs text-gray-500 dark:text-gray-400 space-y-2">
<div class="flex justify-between">
<span>Rows:</span>
<span class="font-medium text-text-light dark:text-text-dark">-</span>
</div>
<div class="flex justify-between">
<span>Columns:</span>
<span class="font-medium text-text-light dark:text-text-dark">-</span>
</div>
<div class="flex justify-between">
<span>Size:</span>
<span class="font-medium text-text-light dark:text-text-dark">-</span>
</div>
</div>
</div>
        <!-- User Rules -->
        <div class="mb-6 p-4 bg-background-light dark:bg-gray-700/50 rounded-lg">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-300 flex items-center">
                    <span class="material-symbols-outlined mr-2 text-base">rule</span>
                    Custom Rules
                </h3>
                <button id="addRuleBtn" class="text-xs px-2 py-1 bg-primary text-white rounded hover:bg-primary-dark">
                    Add
                </button>
            </div>
            <div id="rulesContainer" class="text-xs text-gray-500 dark:text-gray-400 space-y-2 max-h-32 overflow-y-auto">
                <p class="text-center">No custom rules defined</p>
            </div>
        </div>
<button class="w-full bg-primary text-white py-3 px-4 rounded-lg flex items-center justify-center space-x-2 hover:bg-blue-800 transition-all duration-300">
<span class="material-symbols-outlined">add</span>
<span>New Chat</span>
</button>
<nav class="mt-8">
<h2 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">Recent Chats</h2>
<ul id="recentChatsList">
<li class="text-center text-xs text-gray-500 dark:text-gray-400 py-4">
No recent chats
</li>
</ul>
</nav>
</div>
<div>
<div class="mb-4">
<h2 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3 px-2">Added Rules</h2>
<div class="p-3 bg-background-light dark:bg-gray-700/50 rounded-lg">
<p class="text-sm text-gray-700 dark:text-gray-300">No specific rules added yet. Your instructions will appear here.</p>
</div>
</div>
<div class="space-y-2">
<a class="flex items-center p-2 rounded-lg hover:bg-background-light dark:hover:bg-gray-700 transition-colors duration-200" href="#">
<span class="material-symbols-outlined mr-3">settings</span>
<span>Settings</span>
</a>
</div>
</div>
</aside>
<main class="flex-1 flex flex-col">
<header class="flex justify-end p-4">
<div class="flex items-center space-x-2 bg-surface-light dark:bg-surface-dark px-3 py-2 rounded-lg shadow">
<span class="relative flex h-3 w-3">
<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
<span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
</span>
<span class="text-sm font-medium text-gray-700 dark:text-gray-300">Model Connected</span>
</div>
</header>
<div class="flex-1 flex flex-col items-center justify-center text-center px-6 md:px-8 lg:px-12" id="chat-start-view">
<div class="p-6 bg-surface-light dark:bg-surface-dark rounded-full shadow-md mb-6">
<img alt="AI Sima Logo" class="h-16 w-16" src="https://lh3.googleusercontent.com/aida-public/AB6AXuDrV3wMz1y8p1AO2MeFNOf4mDe7h5HhHexXmzsvTv422mkMDfY0qt0KV7ApXvXhV1WyEioGyl2I6NDN2wnuZzGkvhfyu8o7XEh9ijRojR9d1QCsBOWXeouL7_h7kOK1s-NkV5d4ivRoMry8QNJsawlu2rLlshRSYINwED3nX_c6GCfeDYTPF-RCunwAdWpiqudL_TgV1zJ2XwMar2sSLvr1gKuw_2Bszs0Cv_cUPdZRRBoR2kX8WyB7De2xeLsZ7r6uiqHaNyvU7Na0"/>
</div>
<h2 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-white mb-2">How can I help you today?</h2>
<p class="text-gray-600 dark:text-gray-400 max-w-lg">Start by uploading a file or ask me a general question. I can help you with Excel files, documents, and more.</p>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-12 w-full max-w-3xl">
<div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow duration-300">
<div class="flex items-center text-primary dark:text-blue-300 mb-3">
<span class="material-symbols-outlined text-3xl">lightbulb</span>
<h3 class="font-semibold text-lg ml-2">Examples</h3>
</div>
<p class="text-sm text-gray-600 dark:text-gray-400 mb-4">"Summarize the key findings from the attached sales report."</p>
<p class="text-sm text-gray-600 dark:text-gray-400 mb-4">"Which product had the highest growth in Q4?"</p>
<p class="text-sm text-gray-600 dark:text-gray-400">"Create a bar chart showing sales by region."</p>
</div>
<div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow duration-300">
<div class="flex items-center text-primary dark:text-blue-300 mb-3">
<span class="material-symbols-outlined text-3xl">build_circle</span>
<h3 class="font-semibold text-lg ml-2">Capabilities</h3>
</div>
<p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Understands complex queries about your data.</p>
<p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Can generate charts and visualizations.</p>
<p class="text-sm text-gray-600 dark:text-gray-400">Supports multiple languages and file formats.</p>
</div>
</div>
</div>
<div class="hidden flex-1 overflow-y-auto pb-4" id="chat-conversation-view">
</div>
<div class="mt-auto p-6 md:p-8 lg:p-12 pt-4">
<div class="relative">
<textarea class="w-full py-4 pl-14 pr-20 bg-surface-light dark:bg-surface-dark rounded-xl border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary focus:outline-none resize-none" id="chat-input" placeholder="Ask a question or upload a file..." rows="1"></textarea>
<div class="absolute left-4 top-1/2 -translate-y-1/2">
<button class="p-2 text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-blue-300 transition-colors">
<label class="cursor-pointer" for="file-upload">
<span class="material-symbols-outlined">attach_file</span>
</label>
<input class="hidden" id="file-upload" type="file" accept=".csv,.xlsx,.xls"/>
</button>
</div>
<div class="absolute right-4 top-1/2 -translate-y-1/2 flex items-center space-x-2">
<button class="bg-primary text-white w-10 h-10 rounded-lg flex items-center justify-center hover:bg-blue-800 transition-colors">
<span class="material-symbols-outlined">send</span>
</button>
</div>
</div>
</div>
</main>
</div>
    <script>
      (function(){
        const startView = document.getElementById('chat-start-view');
        const convoView = document.getElementById('chat-conversation-view');
        const input = document.getElementById('chat-input');
        const sendBtn = document.querySelector('.absolute.right-4 button');
        const fileInput = document.getElementById('file-upload');
        let ws = null;
        let containers = null;
        let currentFile = null;

        function connectWS(){
          const proto = location.protocol === 'https:' ? 'wss' : 'ws';
          const base = location.host ? (proto + '://' + location.host) : 'ws://127.0.0.1:8010';
          ws = new WebSocket(base + '/ws');
          ws.onmessage = (ev)=>{
            try {
              const msg = JSON.parse(ev.data);
              if(msg.event === 'start'){
                // Don't switch views here - user message display already handled this
                // Create containers for the 3 fields
                containers = {
                  initial_response: document.createElement('div'),
                  generated_code: document.createElement('div'),
                  result_commentary: document.createElement('div'),
                  visualizations: document.createElement('div')
                };

                // Style the containers
                containers.initial_response.className = 'p-4 mb-3 bg-surface-light dark:bg-surface-dark rounded-xl';
                containers.initial_response.innerHTML = '<h3 class="font-semibold mb-2 text-primary">Analysis</h3><pre class="whitespace-pre-wrap text-sm"></pre>';

                containers.generated_code.className = 'p-4 mb-3 bg-surface-light dark:bg-surface-dark rounded-xl';
                containers.generated_code.innerHTML = '<h3 class="font-semibold mb-2 text-primary">Generated Code</h3><pre class="whitespace-pre-wrap text-sm bg-gray-100 dark:bg-gray-800 p-3 rounded"></pre>';

                containers.result_commentary.className = 'p-4 mb-3 bg-surface-light dark:bg-surface-dark rounded-xl';
                containers.result_commentary.innerHTML = '<h3 class="font-semibold mb-2 text-primary">Results & Commentary</h3><pre class="whitespace-pre-wrap text-sm"></pre>';

                containers.visualizations.className = 'p-4 mb-3 bg-surface-light dark:bg-surface-dark rounded-xl hidden';
                containers.visualizations.innerHTML = '<h3 class="font-semibold mb-2 text-primary">Visualizations</h3><div class="viz-container"></div>';

                convoView.appendChild(containers.initial_response);
                convoView.appendChild(containers.generated_code);
                convoView.appendChild(containers.visualizations);
                convoView.appendChild(containers.result_commentary);
                convoView.scrollTop = convoView.scrollHeight;
              } else if(msg.event === 'delta' && containers && msg.field && msg.delta){
                const preElement = containers[msg.field].querySelector('pre');
                if (preElement) {
                  preElement.textContent += msg.delta;
                }
                convoView.scrollTop = convoView.scrollHeight;
              } else if(msg.event === 'end' && msg.final){
                // Handle final response and extract visualizations
                handleFinalResponse(msg.final);
              }
            } catch(e){ console.error('WS message parse error', e); }
          };
          ws.onclose = ()=>{ ws = null; };
        }

        function sendMessage(){
          const text = (input.value || '').trim();
          if(!text) return;

          // Show user message immediately
          displayUserMessage(text);

          // Function to actually send the message
          const doSend = () => {
            if(ws && ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify({ message: text }));
              input.value = '';
              return true;
            }
            return false;
          };

          // Try to send immediately if WebSocket is open
          if(doSend()) {
            return;
          }

          // If WebSocket is not ready, establish connection and wait
          if(!ws || ws.readyState === WebSocket.CLOSED) {
            connectWS();
          }

          // Set up onopen handler to send when ready
          if(ws) {
            ws.onopen = () => {
              doSend();
            };
          }
        }

        function displayUserMessage(message) {
          // Switch to conversation view if not already shown
          if (!convoView.classList.contains('hidden')) {
            // Already in conversation view, just add the message
          } else {
            // First message - switch views
            startView.classList.add('hidden');
            convoView.classList.remove('hidden');
          }

          // Create user message container
          const userMessageDiv = document.createElement('div');
          userMessageDiv.className = 'mb-4 flex justify-end';
          userMessageDiv.innerHTML = `
            <div class="max-w-xs lg:max-w-md px-4 py-2 bg-primary text-white rounded-lg">
              <p class="text-sm">${message}</p>
            </div>
          `;

          convoView.appendChild(userMessageDiv);
          convoView.scrollTop = convoView.scrollHeight;
        }

        async function uploadFile(file) {
          const formData = new FormData();
          formData.append('file', file);

          try {
            const response = await fetch('/upload', {
              method: 'POST',
              body: formData
            });

            const result = await response.json();

            if (response.ok) {
              currentFile = result.file_info;
              updateFileInfo(currentFile);
              alert('File uploaded successfully!');
            } else {
              alert('Upload failed: ' + result.detail);
            }
          } catch (error) {
            alert('Upload error: ' + error.message);
          }
        }

        function updateFileInfo(fileInfo) {
          if (!fileInfo) return;

          // Update the file info section in the sidebar
          const fileInfoSection = document.querySelector('.mb-6.p-4.bg-background-light');
          if (fileInfoSection) {
            const rowsSpan = fileInfoSection.querySelector('.flex:nth-child(1) .font-medium');
            const colsSpan = fileInfoSection.querySelector('.flex:nth-child(2) .font-medium');
            const sizeSpan = fileInfoSection.querySelector('.flex:nth-child(3) .font-medium');

            if (rowsSpan) rowsSpan.textContent = fileInfo.rows.toLocaleString();
            if (colsSpan) colsSpan.textContent = fileInfo.columns;
            if (sizeSpan) sizeSpan.textContent = fileInfo.size_mb + ' MB';
          }
        }

        function handleFinalResponse(finalResponse) {
          // Check if we need to fetch execution results for visualizations
          if (finalResponse.generated_code && finalResponse.generated_code.trim()) {
            // Execute the code to get visualizations
            fetch('/execute-code', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({code: finalResponse.generated_code})
            })
            .then(response => response.json())
            .then(result => {
              if (result.status === 'success' && result.results) {
                displayVisualizations(result.results);
              }
            })
            .catch(error => console.error('Error executing code for visualizations:', error));
          }
        }

        function displayVisualizations(results) {
          const vizContainer = containers.visualizations.querySelector('.viz-container');
          vizContainer.innerHTML = '';
          let hasViz = false;

          // Look for Plotly figures in results
          Object.keys(results).forEach(key => {
            const entry = results[key];
            if (key.includes('plotly_figure') && entry.type === 'plotly_figure') {
              hasViz = true;

              // Create a div for this visualization
              const vizDiv = document.createElement('div');
              vizDiv.className = 'mb-4 p-3 border border-gray-200 dark:border-gray-600 rounded';
              vizDiv.id = 'plot_' + Math.random().toString(36).substr(2, 9);

              // Add title
              const title = document.createElement('h4');
              title.className = 'text-sm font-medium mb-2 text-gray-700 dark:text-gray-300';
              title.textContent = key.replace('plotly_figure_', '').replace('_', ' ').toUpperCase();
              vizDiv.appendChild(title);

              // Add plot container
              const plotDiv = document.createElement('div');
              plotDiv.id = vizDiv.id + '_plot';
              plotDiv.style.width = '100%';
              plotDiv.style.height = '400px';
              vizDiv.appendChild(plotDiv);

              vizContainer.appendChild(vizDiv);

              let figurePayload = entry.payload || null;

              if (!figurePayload) {
                const rawJson = entry.json;
                if (typeof rawJson === 'string') {
                  try {
                    figurePayload = JSON.parse(rawJson);
                  } catch (parseError) {
                    console.error('Error parsing Plotly figure JSON:', parseError);
                  }
                } else if (rawJson) {
                  figurePayload = rawJson;
                }
              }

              if (!figurePayload) {
                plotDiv.innerHTML = '<p class="text-red-500">Unable to display visualization</p>';
                return;
              }

              const data = Array.isArray(figurePayload.data) ? figurePayload.data : [];
              const layout = figurePayload.layout || {};
              const frames = Array.isArray(figurePayload.frames) ? figurePayload.frames : [];

              Plotly.newPlot(plotDiv, data, layout, {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                displaylogo: false
              }).then(createdPlot => {
                if (frames.length) {
                  Plotly.addFrames(createdPlot, frames);
                }
              }).catch(error => {
                console.error('Error rendering Plotly figure:', error);
                plotDiv.innerHTML = '<p class="text-red-500">Error rendering visualization</p>';
              });
            }
          });


          // Show visualizations container if we have any
          if (hasViz) {
            containers.visualizations.classList.remove('hidden');
          }
        }

        sendBtn.addEventListener('click', sendMessage);
        input.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
        });

        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            uploadFile(file);
          }
        });

        // Load existing file info on page load
        fetch('/file-info')
          .then(response => response.json())
          .then(result => {
            if (result.status === 'success') {
              currentFile = result.file_info;
              updateFileInfo(currentFile);
            }
          })
          .catch(error => console.log('No existing file'));
      })();

        // Load existing rules on page load
        loadRules();

        // Rules management functions
        function loadRules() {
          fetch('/rules')
            .then(response => response.json())
            .then(result => {
              if (result.status === 'success') {
                displayRules(result.rules);
              }
            })
            .catch(error => console.error('Error loading rules:', error));
        }

        function displayRules(rules) {
          const container = document.getElementById('rulesContainer');

          if (rules.length === 0) {
            container.innerHTML = '<p class="text-center">No custom rules defined</p>';
            return;
          }

          container.innerHTML = rules.map(rule => `
            <div class="flex justify-between items-start p-2 bg-gray-100 dark:bg-gray-600 rounded">
              <div class="flex-1">
                <p class="text-xs">${rule.text}</p>
                <span class="text-xs text-gray-400">${rule.category}</span>
              </div>
              <button onclick="deleteRule(${rule.id})" class="ml-2 text-red-500 hover:text-red-700">
                <span class="material-symbols-outlined text-sm">delete</span>
              </button>
            </div>
          `).join('');
        }

        function addRule() {
          const ruleText = prompt('Enter a new rule:');
          if (!ruleText || !ruleText.trim()) return;

          const category = prompt('Enter category (optional):', 'general') || 'general';

          fetch('/rules', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              text: ruleText.trim(),
              category: category.trim(),
              priority: 1
            })
          })
          .then(response => response.json())
          .then(result => {
            if (result.status === 'success') {
              loadRules(); // Reload rules
            } else {
              alert('Failed to add rule: ' + result.message);
            }
          })
          .catch(error => {
            console.error('Error adding rule:', error);
            alert('Failed to add rule');
          });
        }

        function deleteRule(ruleId) {
          if (!confirm('Are you sure you want to delete this rule?')) return;

          fetch(`/rules/${ruleId}`, {
            method: 'DELETE'
          })
          .then(response => response.json())
          .then(result => {
            if (result.status === 'success') {
              loadRules(); // Reload rules
            } else {
              alert('Failed to delete rule: ' + result.message);
            }
          })
          .catch(error => {
            console.error('Error deleting rule:', error);
            alert('Failed to delete rule');
          });
        }

        // Add event listener for add rule button
        document.getElementById('addRuleBtn').addEventListener('click', addRule);
    </script>

</body></html>