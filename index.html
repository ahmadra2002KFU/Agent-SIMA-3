<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>AI Sima - Chat with your data</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
<script src="https://cdn.plot.ly/plotly-2.30.1.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<!-- Prism.js for syntax highlighting -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#0D47A1", // A deep blue from the logo
                        "background-light": "#F0F4F8",
                        "background-dark": "#121212",
                        "surface-light": "#FFFFFF",
                        "surface-dark": "#1E1E1E",
                        "text-light": "#1A202C",
                        "text-dark": "#E2E8F0",
                        "accent-red": "#D32F2F", // Red from the crescent
                    },
                    fontFamily: {
                        display: ["Sora", "sans-serif"],
                    },
                    borderRadius: {
                        'DEFAULT': '0.75rem',
                        'lg': '1rem',
                        'xl': '1.5rem',
                    },
                },
            },
        };
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL'0,
            'wght'400,
            'GRAD'0,
            'opsz'24
        }
        
        /* Mobile responsive design */
        @media (max-width: 768px) {
            /* Mobile sidebar behavior - overlay instead of push */
            .sidebar-container {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 288px;
                z-index: 50;
                border-right: 1px solid rgb(229, 231, 235);
            }

            .sidebar-collapsed {
                transform: translateX(-100%);
                opacity: 0;
            }

            .dark .sidebar-container {
                border-right-color: rgb(75, 85, 99);
            }

            /* Main content takes full width on mobile */
            .main-content {
                width: 100%;
                margin-left: 0 !important;
            }

            /* Add backdrop when sidebar is open on mobile */
            .sidebar-backdrop {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.5);
                z-index: 40;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            }

            .sidebar-backdrop.active {
                opacity: 1;
                visibility: visible;
            }
        }
        
        /* Ensure z-index layering */
        .animate-ping {
            z-index: 1;
        }
        
        /* Prevent text overflow in containers */
        pre {
            word-wrap: break-word;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }
        
        /* Ensure proper spacing for dynamic content */
        #chat-conversation-view > div {
            margin-bottom: 1rem;
        }
        
        /* Prevent button overlap in chat input */
        #chat-input:focus {
            z-index: 5;
        }
        
        .viz-container > div {
            margin-bottom: 1.5rem;
        }
        
        /* Ensure dropdowns and modals appear above other content */
        .relative {
            isolation: isolate;
        }

        /* Enhanced code block styling */
        .code-block-container {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            overflow: hidden;
            background: #ffffff;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            max-width: 100%;
            width: 100%;
        }

        .dark .code-block-container {
            border-color: #374151;
            background: #1f2937;
        }

        .code-block-header {
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dark .code-block-header {
            background: #111827;
            border-bottom-color: #374151;
        }

        .code-block-language {
            font-size: 0.75rem;
            font-weight: 600;
            color: #0D47A1;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .dark .code-block-language {
            color: #60a5fa;
        }

        .code-block-copy-btn {
            background: #0D47A1;
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .code-block-copy-btn:hover {
            background: #1565c0;
        }

        .dark .code-block-copy-btn {
            background: #1d4ed8;
        }

        .dark .code-block-copy-btn:hover {
            background: #2563eb;
        }

        .code-block-content {
            position: relative;
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        /* Custom scrollbar styling for code blocks */
        .code-block-content::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .code-block-content::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .dark .code-block-content::-webkit-scrollbar-track {
            background: #374151;
        }

        .code-block-content::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .code-block-content::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .dark .code-block-content::-webkit-scrollbar-thumb {
            background: #6b7280;
        }

        .dark .code-block-content::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .code-block-content pre {
            margin: 0;
            padding: 1rem;
            background: transparent !important;
            font-family: 'Fira Code', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            white-space: pre;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .code-block-content code {
            background: transparent !important;
            padding: 0 !important;
        }

        /* Override Prism theme colors to match our design */
        .token.comment,
        .token.prolog,
        .token.doctype,
        .token.cdata {
            color: #6b7280;
        }

        .token.punctuation {
            color: #374151;
        }

        .dark .token.punctuation {
            color: #d1d5db;
        }

        .token.property,
        .token.tag,
        .token.boolean,
        .token.number,
        .token.constant,
        .token.symbol,
        .token.deleted {
            color: #dc2626;
        }

        .token.selector,
        .token.attr-name,
        .token.string,
        .token.char,
        .token.builtin,
        .token.inserted {
            color: #059669;
        }

        .token.operator,
        .token.entity,
        .token.url,
        .language-css .token.string,
        .style .token.string {
            color: #0D47A1;
        }

        .token.atrule,
        .token.attr-value,
        .token.keyword {
            color: #7c3aed;
        }

        /* Skeleton Loader Animation */
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        .skeleton-loader {
            animation: shimmer 2s infinite linear;
            background: linear-gradient(
                to right,
                #f0f4f8 0%,
                #e2e8f0 20%,
                #f0f4f8 40%,
                #f0f4f8 100%
            );
            background-size: 1000px 100%;
            border-radius: 0.5rem;
        }

        .dark .skeleton-loader {
            background: linear-gradient(
                to right,
                #1e293b 0%,
                #334155 20%,
                #1e293b 40%,
                #1e293b 100%
            );
            background-size: 1000px 100%;
        }

        .skeleton-results-container {
            background: linear-gradient(to br, #eff6ff, #e0e7ff);
            border: 2px solid #0D47A1;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 0.75rem;
        }

        .dark .skeleton-results-container {
            background: linear-gradient(to br, #1f2937, #111827);
            border-color: #60a5fa;
        }

        .skeleton-value {
            height: 3rem;
            width: 60%;
            margin-bottom: 0.75rem;
        }

        .skeleton-label {
            height: 1rem;
            width: 40%;
        }
        }

        .token.function,
        .token.class-name {
            color: #0891b2;
        }

        .token.regex,
        .token.important,
        .token.variable {
            color: #ea580c;
        }

        /* Sidebar Toggle Animations */
        .sidebar-container {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            overflow: hidden;
        }

        .sidebar-collapsed {
            transform: translateX(-100%);
            opacity: 0;
            pointer-events: none;
        }

        .sidebar-content {
            width: 288px;
        }

        .main-content {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-expanded {
            margin-left: -288px;
        }

        /* Toggle button animation and feedback */
        #sidebar-toggle {
            transition: all 0.2s ease-in-out;
            position: relative;
        }

        #sidebar-toggle:hover {
            transform: scale(1.05);
            background-color: rgba(13, 71, 161, 0.1);
        }

        #sidebar-toggle:active {
            transform: scale(0.95);
            background-color: rgba(13, 71, 161, 0.2);
        }

        /* Visual feedback for toggle state */
        #sidebar-toggle .material-symbols-outlined {
            transition: transform 0.3s ease-in-out;
        }

        .sidebar-collapsed ~ main #sidebar-toggle .material-symbols-outlined {
            transform: rotate(180deg);
        }

        /* Responsive design for code blocks */
        @media (max-width: 768px) {
            .code-block-content {
                max-height: 300px;
            }

            .code-block-content pre {
                font-size: 0.75rem;
                padding: 0.75rem;
            }

            .code-block-header {
                padding: 0.5rem 0.75rem;
            }

            .code-block-copy-btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.625rem;
            }

            /* Ensure toggle button is visible on mobile */
            #sidebar-toggle {
                display: block;
            }
        }

        @media (max-width: 480px) {
            .code-block-content {
                max-height: 250px;
            }

            .code-block-content pre {
                font-size: 0.7rem;
                padding: 0.5rem;
            }
        }

        /* Modern Premium Input Design */
        .premium-input-container {
            position: relative;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            border: 2px solid rgba(13, 71, 161, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08),
                        0 2px 8px rgba(0, 0, 0, 0.04),
                        inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark .premium-input-container {
            background: rgba(30, 30, 30, 0.8);
            border-color: rgba(96, 165, 250, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4),
                        0 2px 8px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .premium-input-container:hover {
            border-color: rgba(13, 71, 161, 0.3);
            box-shadow: 0 12px 48px rgba(13, 71, 161, 0.12),
                        0 4px 12px rgba(0, 0, 0, 0.06),
                        inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
        }

        .dark .premium-input-container:hover {
            border-color: rgba(96, 165, 250, 0.4);
            box-shadow: 0 12px 48px rgba(96, 165, 250, 0.2),
                        0 4px 12px rgba(0, 0, 0, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.08);
        }

        .premium-input-container.focused {
            border-color: rgba(13, 71, 161, 0.5);
            box-shadow: 0 0 0 4px rgba(13, 71, 161, 0.1),
                        0 12px 48px rgba(13, 71, 161, 0.15),
                        0 4px 12px rgba(0, 0, 0, 0.08),
                        inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
        }

        .dark .premium-input-container.focused {
            border-color: rgba(96, 165, 250, 0.6);
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.15),
                        0 12px 48px rgba(96, 165, 250, 0.25),
                        0 4px 12px rgba(0, 0, 0, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .premium-textarea {
            background: transparent;
            border: none;
            outline: none;
            resize: none;
            font-size: 0.9375rem;
            line-height: 1.6;
            color: #1a202c;
            font-weight: 400;
            transition: all 0.2s ease;
        }

        .dark .premium-textarea {
            color: #e2e8f0;
        }

        .premium-textarea::placeholder {
            color: #94a3b8;
            font-weight: 400;
        }

        .dark .premium-textarea::placeholder {
            color: #64748b;
        }

        .premium-attach-btn {
            position: relative;
            background: linear-gradient(135deg, rgba(13, 71, 161, 0.08) 0%, rgba(96, 165, 250, 0.08) 100%);
            border-radius: 0.75rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .premium-attach-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(13, 71, 161, 0.15) 0%, rgba(96, 165, 250, 0.15) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .premium-attach-btn:hover::before {
            opacity: 1;
        }

        .premium-attach-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(13, 71, 161, 0.2);
        }

        .premium-attach-btn:active {
            transform: scale(0.95);
        }

        .dark .premium-attach-btn {
            background: linear-gradient(135deg, rgba(96, 165, 250, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
        }

        .premium-send-btn {
            position: relative;
            background: linear-gradient(135deg, #0D47A1 0%, #1976D2 100%);
            border-radius: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(13, 71, 161, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .premium-send-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .premium-send-btn:hover::before {
            opacity: 1;
        }

        .premium-send-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 24px rgba(13, 71, 161, 0.4),
                        0 4px 12px rgba(13, 71, 161, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .premium-send-btn:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 8px rgba(13, 71, 161, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .premium-send-btn .material-symbols-outlined {
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            transition: transform 0.3s ease;
        }

        .premium-send-btn:hover .material-symbols-outlined {
            transform: translateX(2px);
        }

        .dark .premium-send-btn {
            background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 100%);
            box-shadow: 0 4px 16px rgba(29, 78, 216, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        .dark .premium-send-btn:hover {
            box-shadow: 0 8px 24px rgba(29, 78, 216, 0.5),
                        0 4px 12px rgba(29, 78, 216, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        /* Pulse animation for send button when ready */
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 4px 16px rgba(13, 71, 161, 0.3),
                            inset 0 1px 0 rgba(255, 255, 255, 0.2);
            }
            50% {
                box-shadow: 0 4px 20px rgba(13, 71, 161, 0.5),
                            0 0 24px rgba(13, 71, 161, 0.2),
                            inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }
        }

        .premium-send-btn.has-content {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        /* Icon animations */
        .premium-icon {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .premium-attach-btn:hover .premium-icon {
            color: #0D47A1;
            transform: rotate(-15deg);
        }

        .dark .premium-attach-btn:hover .premium-icon {
            color: #60a5fa;
        }

        /* Input wrapper outer container */
        .premium-input-wrapper {
            position: relative;
            padding: 1rem;
            background: linear-gradient(180deg, rgba(13, 71, 161, 0.02) 0%, transparent 100%);
            border-radius: 2rem;
        }

        .dark .premium-input-wrapper {
            background: linear-gradient(180deg, rgba(96, 165, 250, 0.03) 0%, transparent 100%);
        }

        /* Premium Chat Message Styling */
        .user-message {
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .user-message-bubble {
            background: linear-gradient(135deg, #0D47A1 0%, #1565C0 100%);
            box-shadow: 0 4px 16px rgba(13, 71, 161, 0.25),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
        }

        .user-message-bubble:hover {
            box-shadow: 0 6px 20px rgba(13, 71, 161, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .ai-response-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(13, 71, 161, 0.1);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
            animation: fadeInUp 0.4s ease-out;
        }

        .dark .ai-response-card {
            background: rgba(30, 30, 30, 0.7);
            border-color: rgba(96, 165, 250, 0.15);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
        }

        .ai-response-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            border-color: rgba(13, 71, 161, 0.2);
        }

        .dark .ai-response-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            border-color: rgba(96, 165, 250, 0.25);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-header-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, rgba(13, 71, 161, 0.1) 0%, rgba(96, 165, 250, 0.1) 100%);
            border-radius: 6px;
            margin-right: 8px;
        }

        .dark .card-header-icon {
            background: linear-gradient(135deg, rgba(96, 165, 250, 0.15) 0%, rgba(59, 130, 246, 0.15) 100%);
        }

        .section-title {
            display: flex;
            align-items: center;
            font-weight: 600;
            font-size: 0.9375rem;
            color: #0D47A1;
            margin-bottom: 0.75rem;
        }

        .dark .section-title {
            color: #60a5fa;
        }

        .content-text {
            font-size: 0.9rem;
            line-height: 1.7;
            color: #374151;
        }

        .dark .content-text {
            color: #d1d5db;
        }

        /* Better spacing for conversation view */
        #chat-conversation-view {
            padding: 1.5rem 1rem;
        }

        @media (min-width: 768px) {
            #chat-conversation-view {
                padding: 2rem 2rem;
            }
        }

        @media (min-width: 1024px) {
            #chat-conversation-view {
                padding: 2.5rem 3rem;
            }
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-light dark:text-text-dark transition-colors duration-300">
<!-- Mobile sidebar backdrop -->
<div id="sidebar-backdrop" class="sidebar-backdrop"></div>
<div class="flex h-screen relative">
<aside id="sidebar" class="sidebar-container w-72 bg-surface-light dark:bg-surface-dark shadow-lg relative z-20 border-r border-gray-200 dark:border-gray-700">
<div class="sidebar-content p-6 flex flex-col justify-between h-full">
<div>
<div class="flex items-center space-x-3 mb-6">
<img alt="AI Sima Logo" class="h-10 w-10" src="/static/aisimalogo.png"/>
<h1 class="text-2xl font-bold text-primary dark:text-white">AI Sima</h1>
</div>
<div class="mb-6 p-4 bg-background-light dark:bg-gray-700/50 rounded-lg">
<h3 class="text-sm font-semibold text-gray-600 dark:text-gray-300 mb-3 flex items-center">
<span class="material-symbols-outlined mr-2 text-base">description</span>
                        File Info
                    </h3>
<div class="text-xs text-gray-500 dark:text-gray-400 space-y-2">
<div class="flex justify-between">
<span>Rows:</span>
<span class="font-medium text-text-light dark:text-text-dark">-</span>
</div>
<div class="flex justify-between">
<span>Columns:</span>
<span class="font-medium text-text-light dark:text-text-dark">-</span>
</div>
<div class="flex justify-between">
<span>Size:</span>
<span class="font-medium text-text-light dark:text-text-dark">-</span>
</div>
</div>
</div>
        <!-- User Rules -->
        <div class="mb-6 p-4 bg-background-light dark:bg-gray-700/50 rounded-lg">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-300 flex items-center">
                    <span class="material-symbols-outlined mr-2 text-base">rule</span>
                    Custom Rules
                </h3>
                <button id="addRuleBtn" class="text-xs px-2 py-1 bg-primary text-white rounded hover:bg-primary-dark">
                    Add
                </button>
            </div>
            <div id="rulesContainer" class="text-xs text-gray-500 dark:text-gray-400 space-y-2 max-h-32 overflow-y-auto relative z-10">
                <p class="text-center">No custom rules defined</p>
            </div>
        </div>
<button class="w-full bg-primary text-white py-3 px-4 rounded-lg flex items-center justify-center space-x-2 hover:bg-blue-800 transition-all duration-300">
<span class="material-symbols-outlined">add</span>
<span>New Chat</span>
</button>
<nav class="mt-8">
<h2 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">Recent Chats</h2>
<ul id="recentChatsList">
<li class="text-center text-xs text-gray-500 dark:text-gray-400 py-4">
No recent chats
</li>
</ul>
</nav>
</div>
<div>
<div class="mb-4">
<h2 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3 px-2">Added Rules</h2>
<div class="p-3 bg-background-light dark:bg-gray-700/50 rounded-lg">
<p class="text-sm text-gray-700 dark:text-gray-300">No specific rules added yet. Your instructions will appear here.</p>
</div>
</div>
<div class="space-y-2">
<a class="flex items-center p-2 rounded-lg hover:bg-background-light dark:hover:bg-gray-700 transition-colors duration-200" href="#">
<span class="material-symbols-outlined mr-3">settings</span>
<span>Settings</span>
</a>
</div>
</div>
</div>
</aside>
<main id="main-content" class="main-content flex-1 flex flex-col relative">
<header class="flex justify-between items-center p-4 relative z-30">
<!-- Sidebar Toggle Button -->
<button id="sidebar-toggle" class="p-2 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-blue-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50" aria-label="Toggle sidebar">
<span class="material-symbols-outlined text-2xl">menu</span>
</button>

<!-- Model Status -->
<div class="flex items-center space-x-2 bg-surface-light dark:bg-surface-dark px-4 py-3 rounded-lg shadow-lg border border-gray-200 dark:border-gray-600">
<span class="relative flex h-3 w-3 z-10">
<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
<span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
</span>
<span class="text-sm font-medium text-gray-700 dark:text-gray-300 whitespace-nowrap">Model Connected</span>
</div>
</header>
<div class="flex-1 flex flex-col items-center justify-center text-center px-6 md:px-8 lg:px-12 relative z-10" id="chat-start-view">
<div class="p-6 bg-surface-light dark:bg-surface-dark rounded-full shadow-md mb-6">
<img alt="AI Sima Logo" class="h-16 w-16" src="/static/aisimalogo.png"/>
</div>
<h2 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-white mb-2">How can I help you today?</h2>
<p class="text-gray-600 dark:text-gray-400 max-w-lg">Start by uploading a file or ask me a general question. I can help you with Excel files, documents, and more.</p>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-12 w-full max-w-3xl">
<div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow duration-300">
<div class="flex items-center text-primary dark:text-blue-300 mb-3">
<span class="material-symbols-outlined text-3xl">lightbulb</span>
<h3 class="font-semibold text-lg ml-2">Examples</h3>
</div>
<p class="text-sm text-gray-600 dark:text-gray-400 mb-4">"Summarize the key findings from the attached sales report."</p>
<p class="text-sm text-gray-600 dark:text-gray-400 mb-4">"Which product had the highest growth in Q4?"</p>
<p class="text-sm text-gray-600 dark:text-gray-400">"Create a bar chart showing sales by region."</p>
</div>
<div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow duration-300">
<div class="flex items-center text-primary dark:text-blue-300 mb-3">
<span class="material-symbols-outlined text-3xl">build_circle</span>
<h3 class="font-semibold text-lg ml-2">Capabilities</h3>
</div>
<p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Understands complex queries about your data.</p>
<p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Can generate charts and visualizations.</p>
<p class="text-sm text-gray-600 dark:text-gray-400">Supports multiple languages and file formats.</p>
</div>
</div>
</div>
<div class="hidden flex-1 overflow-y-auto pb-4 px-4 relative z-10" id="chat-conversation-view">
</div>
<div class="mt-auto p-6 md:p-8 lg:p-12 pt-4 relative z-10">
<div class="premium-input-wrapper">
<div class="premium-input-container" id="input-container">
<div class="relative flex items-center gap-3 p-3">
<!-- Attach File Button -->
<button class="premium-attach-btn p-2.5 flex-shrink-0 z-20">
<label class="cursor-pointer flex items-center justify-center" for="file-upload">
<span class="material-symbols-outlined text-xl premium-icon text-gray-600 dark:text-gray-400">attach_file</span>
</label>
<input class="hidden" id="file-upload" type="file" accept=".csv,.xlsx,.xls"/>
</button>
<!-- Textarea -->
<textarea class="premium-textarea flex-1 py-2.5 px-1 max-h-32 overflow-y-auto" id="chat-input" placeholder="Ask a question or upload a file..." rows="1"></textarea>
<!-- Send Button -->
<button id="send-btn" class="premium-send-btn text-white w-12 h-12 flex-shrink-0 flex items-center justify-center z-20">
<span class="material-symbols-outlined text-xl">send</span>
</button>
</div>
</div>
</div>
</div>
</main>
</div>
    <script>
      (function(){
        // Sidebar Toggle Functionality
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const mainContent = document.getElementById('main-content');
        const sidebarBackdrop = document.getElementById('sidebar-backdrop');

        // Check if we're on mobile
        function isMobile() {
          return window.innerWidth <= 768;
        }

        // Load sidebar state from localStorage (only for desktop)
        const sidebarCollapsed = !isMobile() && localStorage.getItem('sidebarCollapsed') === 'true';

        // Apply initial state
        if (sidebarCollapsed && !isMobile()) {
          sidebar.classList.add('sidebar-collapsed');
          mainContent.classList.add('main-expanded');
        } else if (isMobile()) {
          // On mobile, start with sidebar collapsed
          sidebar.classList.add('sidebar-collapsed');
        }

        // Update toggle button icon
        function updateToggleIcon() {
          const isCollapsed = sidebar.classList.contains('sidebar-collapsed');
          const icon = sidebarToggle.querySelector('.material-symbols-outlined');
          if (icon) {
            icon.textContent = isCollapsed ? 'menu_open' : 'menu';
          }
        }

        // Set initial icon
        updateToggleIcon();

        // Toggle function with smooth animation
        function toggleSidebar() {
          const isCollapsed = sidebar.classList.contains('sidebar-collapsed');
          const mobile = isMobile();

          if (isCollapsed) {
            // Expand sidebar
            sidebar.classList.remove('sidebar-collapsed');
            if (!mobile) {
              mainContent.classList.remove('main-expanded');
              localStorage.setItem('sidebarCollapsed', 'false');
            } else {
              // Show backdrop on mobile
              sidebarBackdrop.classList.add('active');
            }
          } else {
            // Collapse sidebar
            sidebar.classList.add('sidebar-collapsed');
            if (!mobile) {
              mainContent.classList.add('main-expanded');
              localStorage.setItem('sidebarCollapsed', 'true');
            } else {
              // Hide backdrop on mobile
              sidebarBackdrop.classList.remove('active');
            }
          }

          // Update icon to reflect new state
          updateToggleIcon();
        }

        // Add event listener to toggle button
        sidebarToggle.addEventListener('click', toggleSidebar);

        // Close sidebar when clicking backdrop on mobile
        sidebarBackdrop.addEventListener('click', () => {
          if (isMobile()) {
            sidebar.classList.add('sidebar-collapsed');
            sidebarBackdrop.classList.remove('active');
            updateToggleIcon();
          }
        });

        // Handle window resize
        window.addEventListener('resize', () => {
          const mobile = isMobile();
          if (mobile) {
            // On mobile, remove desktop classes and hide backdrop
            mainContent.classList.remove('main-expanded');
            sidebarBackdrop.classList.remove('active');
            if (!sidebar.classList.contains('sidebar-collapsed')) {
              sidebar.classList.add('sidebar-collapsed');
            }
          } else {
            // On desktop, restore saved state and hide backdrop
            sidebarBackdrop.classList.remove('active');
            const savedState = localStorage.getItem('sidebarCollapsed') === 'true';
            if (savedState) {
              sidebar.classList.add('sidebar-collapsed');
              mainContent.classList.add('main-expanded');
            } else {
              sidebar.classList.remove('sidebar-collapsed');
              mainContent.classList.remove('main-expanded');
            }
          }
          // Update icon after resize
          updateToggleIcon();
        });

        // Keyboard shortcut (Ctrl/Cmd + B)
        document.addEventListener('keydown', (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
            e.preventDefault();
            toggleSidebar();
          }
        });

        // Main application variables
        const startView = document.getElementById('chat-start-view');
        const convoView = document.getElementById('chat-conversation-view');
        const input = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const fileInput = document.getElementById('file-upload');
        let ws = null;
        let containers = null;
        let currentFile = null;

        function connectWS(){
          const proto = location.protocol === 'https:' ? 'wss' : 'ws';
          const base = location.host ? (proto + '://' + location.host) : 'ws://127.0.0.1:8010';
          ws = new WebSocket(base + '/ws');
          ws.onmessage = (ev)=>{
            try {
              const msg = JSON.parse(ev.data);
              if(msg.event === 'start'){
                // Don't switch views here - user message display already handled this
                // Create containers for the 5 fields (new order: analysis, code, viz, results, commentary)
                containers = {
                  generated_code: document.createElement('div'),
                  visualizations: document.createElement('div'),
                  initial_response: document.createElement('div'),
                  results_block: document.createElement('div'),
                  result_commentary: document.createElement('div')
                };

                // 1. Analysis (displayed FIRST)
                containers.initial_response.className = 'ai-response-card p-5 mb-4 rounded-xl relative z-10';
                containers.initial_response.innerHTML = `
                  <div class="section-title">
                    <span class="card-header-icon">
                      <span class="material-symbols-outlined text-sm text-primary dark:text-blue-300">analytics</span>
                    </span>
                    Analysis
                  </div>
                  <pre class="content-text whitespace-pre-wrap"></pre>
                `;

                // 2. Python Code Block (displayed SECOND)
                containers.generated_code.className = 'mb-4 relative z-10';
                containers.generated_code.innerHTML = `
                  <div class="code-block-container">
                    <div class="code-block-header">
                      <span class="code-block-language">Python</span>
                      <button class="code-block-copy-btn" onclick="copyCodeToClipboard(this)">
                        <span class="material-symbols-outlined" style="font-size: 14px;">content_copy</span>
                        Copy
                      </button>
                    </div>
                    <div class="code-block-content">
                      <pre><code class="language-python"></code></pre>
                    </div>
                  </div>
                `;

                // 3. Visualizations (displayed THIRD, conditionally)
                containers.visualizations.className = 'ai-response-card p-5 mb-4 rounded-xl relative z-10 hidden';
                containers.visualizations.innerHTML = `
                  <div class="section-title">
                    <span class="card-header-icon">
                      <span class="material-symbols-outlined text-sm text-primary dark:text-blue-300">bar_chart</span>
                    </span>
                    Visualizations
                  </div>
                  <div class="viz-container space-y-4"></div>
                `;

                // 4. Results Block (displayed FOURTH - NEW prominent results display)
                containers.results_block.className = 'ai-response-card p-6 mb-4 rounded-xl relative z-10 hidden';
                containers.results_block.innerHTML = `
                  <div class="section-title">
                    <span class="card-header-icon">
                      <span class="material-symbols-outlined text-sm text-primary dark:text-blue-300">check_circle</span>
                    </span>
                    Results
                  </div>
                  <!-- Skeleton Loader (shown during code execution) -->
                  <div id="results-skeleton" class="skeleton-results-container hidden">
                    <div class="skeleton-loader skeleton-value"></div>
                    <div class="skeleton-loader skeleton-label"></div>
                  </div>
                  <!-- Actual Results (shown after execution completes) -->
                  <div id="results-actual" class="results-content bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-gray-800 dark:to-gray-700 p-6 rounded-lg border-2 border-primary dark:border-blue-400 mt-3 hidden">
                    <div class="text-4xl font-bold text-primary dark:text-blue-300 mb-2 font-mono" id="primary-result-value"></div>
                    <div class="text-sm text-gray-600 dark:text-gray-300" id="primary-result-label"></div>
                  </div>
                `;

                // 5. Commentary (displayed FIFTH)
                containers.result_commentary.className = 'ai-response-card p-5 mb-4 rounded-xl relative z-10';
                containers.result_commentary.innerHTML = `
                  <div class="section-title">
                    <span class="card-header-icon">
                      <span class="material-symbols-outlined text-sm text-primary dark:text-blue-300">description</span>
                    </span>
                    Commentary
                  </div>
                  <pre class="content-text whitespace-pre-wrap"></pre>
                `;

                // Append containers in NEW ORDER: Analysis â†’ Code â†’ Viz â†’ Results â†’ Commentary
                convoView.appendChild(containers.initial_response);
                convoView.appendChild(containers.generated_code);
                convoView.appendChild(containers.visualizations);
                convoView.appendChild(containers.results_block);
                convoView.appendChild(containers.result_commentary);
                convoView.scrollTop = convoView.scrollHeight;
              } else if(msg.event === 'delta' && containers && msg.field && msg.delta){
                if (msg.field === 'generated_code') {
                  const codeElement = containers[msg.field].querySelector('code');
                  if (codeElement) {
                    codeElement.textContent += msg.delta;
                  }
                } else {
                  const preElement = containers[msg.field].querySelector('pre');
                  if (preElement) {
                    preElement.textContent += msg.delta;
                  }
                }
                convoView.scrollTop = convoView.scrollHeight;
              } else if(msg.event === 'replace' && containers && msg.field && msg.content !== undefined){
                // Replace the entire content (used to fix escape sequence issues)
                if (msg.field === 'generated_code') {
                  const codeElement = containers[msg.field].querySelector('code');
                  if (codeElement) {
                    codeElement.textContent = msg.content;
                    // Apply syntax highlighting
                    Prism.highlightElement(codeElement);
                  }
                } else {
                  const preElement = containers[msg.field].querySelector('pre');
                  if (preElement) {
                    preElement.textContent = msg.content;
                  }
                }
                convoView.scrollTop = convoView.scrollHeight;
              } else if(msg.event === 'end' && msg.final){
                // Apply syntax highlighting to the final code
                if (containers && containers.generated_code) {
                  const codeElement = containers.generated_code.querySelector('code');
                  if (codeElement && codeElement.textContent.trim()) {
                    Prism.highlightElement(codeElement);
                  }
                }
                // Handle final response and extract visualizations
                handleFinalResponse(msg.final);
              }
            } catch(e){ console.error('WS message parse error', e); }
          };
          ws.onclose = ()=>{ ws = null; };
        }

        function sendMessage(){
          const text = (input.value || '').trim();
          if(!text) return;

          // Show user message immediately
          displayUserMessage(text);

          // Function to actually send the message
          const doSend = () => {
            if(ws && ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify({ message: text }));
              input.value = '';
              return true;
            }
            return false;
          };

          // Try to send immediately if WebSocket is open
          if(doSend()) {
            return;
          }

          // If WebSocket is not ready, establish connection and wait
          if(!ws || ws.readyState === WebSocket.CLOSED) {
            connectWS();
          }

          // Set up onopen handler to send when ready
          if(ws) {
            ws.onopen = () => {
              doSend();
            };
          }
        }

        function displayUserMessage(message) {
          // Switch to conversation view if not already shown
          if (!convoView.classList.contains('hidden')) {
            // Already in conversation view, just add the message
          } else {
            // First message - switch views
            startView.classList.add('hidden');
            convoView.classList.remove('hidden');
          }

          // Create user message container
          const userMessageDiv = document.createElement('div');
          userMessageDiv.className = 'mb-6 flex justify-end relative z-10 user-message';
          userMessageDiv.innerHTML = `
            <div class="user-message-bubble max-w-xs lg:max-w-md px-5 py-3.5 text-white rounded-2xl">
              <p class="text-sm leading-relaxed">${message}</p>
            </div>
          `;

          convoView.appendChild(userMessageDiv);
          convoView.scrollTop = convoView.scrollHeight;
        }

        async function uploadFile(file) {
          const formData = new FormData();
          formData.append('file', file);

          try {
            const response = await fetch('/upload', {
              method: 'POST',
              body: formData
            });

            const result = await response.json();

            if (response.ok) {
              currentFile = result.file_info;
              updateFileInfo(currentFile);
              alert('File uploaded successfully!');
            } else {
              alert('Upload failed: ' + result.detail);
            }
          } catch (error) {
            alert('Upload error: ' + error.message);
          }
        }

        function updateFileInfo(fileInfo) {
          if (!fileInfo) return;

          // Update the file info section in the sidebar
          const fileInfoSection = document.querySelector('.mb-6.p-4.bg-background-light');
          if (fileInfoSection) {
            const rowsSpan = fileInfoSection.querySelector('.flex:nth-child(1) .font-medium');
            const colsSpan = fileInfoSection.querySelector('.flex:nth-child(2) .font-medium');
            const sizeSpan = fileInfoSection.querySelector('.flex:nth-child(3) .font-medium');

            if (rowsSpan) rowsSpan.textContent = fileInfo.rows.toLocaleString();
            if (colsSpan) colsSpan.textContent = fileInfo.columns;
            if (sizeSpan) sizeSpan.textContent = fileInfo.size_mb + ' MB';
          }
        }

        function handleFinalResponse(finalResponse) {
          // Check if we need to fetch execution results for visualizations and results block
          if (finalResponse.generated_code && finalResponse.generated_code.trim()) {
            // Show skeleton loader and Results Block container
            const resultsBlock = containers.results_block;
            const skeleton = resultsBlock.querySelector('#results-skeleton');
            const actualResults = resultsBlock.querySelector('#results-actual');

            // Show the Results Block container and skeleton loader
            resultsBlock.classList.remove('hidden');
            skeleton.classList.remove('hidden');
            actualResults.classList.add('hidden');

            // Execute the code to get visualizations and results
            fetch('/execute-code', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({code: finalResponse.generated_code})
            })
            .then(response => response.json())
            .then(result => {
              // Hide skeleton loader
              skeleton.classList.add('hidden');

              if (result.status === 'success' && result.results) {
                displayVisualizations(result.results);
                displayResultsBlock(result.results);
              } else {
                // If execution failed, hide the Results Block entirely
                resultsBlock.classList.add('hidden');
              }
            })
            .catch(error => {
              console.error('Error executing code for visualizations:', error);
              // Hide skeleton and Results Block on error
              skeleton.classList.add('hidden');
              resultsBlock.classList.add('hidden');
            });
          }
        }

        function displayResultsBlock(results) {
          // Extract primary result from execution results
          let primaryResult = null;
          let primaryResultKey = null;

          // Look for the main result variable in priority order
          const priorityKeys = ['result', 'output', 'summary', 'analysis', 'answer'];
          for (const key of priorityKeys) {
            if (results.hasOwnProperty(key) && results[key] !== null && results[key] !== undefined) {
              primaryResult = results[key];
              primaryResultKey = key;
              break;
            }
          }

          // If we found a primary result, display it prominently
          if (primaryResult !== null && primaryResult !== undefined) {
            const resultsBlock = containers.results_block;
            const actualResults = resultsBlock.querySelector('#results-actual');
            const valueElement = resultsBlock.querySelector('#primary-result-value');
            const labelElement = resultsBlock.querySelector('#primary-result-label');

            // Format the result value
            let displayValue = primaryResult;
            if (typeof primaryResult === 'number') {
              // Format numbers nicely
              displayValue = primaryResult.toLocaleString(undefined, {
                maximumFractionDigits: 2
              });
            } else if (typeof primaryResult === 'object') {
              // For objects/arrays, show a summary
              if (Array.isArray(primaryResult)) {
                displayValue = `${primaryResult.length} items`;
              } else {
                displayValue = JSON.stringify(primaryResult, null, 2);
              }
            }

            valueElement.textContent = displayValue;
            labelElement.textContent = `Primary result from '${primaryResultKey}' variable`;

            // Show the actual results container (skeleton is already hidden by handleFinalResponse)
            actualResults.classList.remove('hidden');
            resultsBlock.classList.remove('hidden');
          } else {
            // No primary result found, hide the entire Results Block
            const resultsBlock = containers.results_block;
            resultsBlock.classList.add('hidden');
          }
        }

        function displayVisualizations(results) {
          const vizContainer = containers.visualizations.querySelector('.viz-container');
          // Clear previous visualizations to avoid stale/duplicate plots
          vizContainer.innerHTML = '';
          let hasViz = false;

          // Look for Plotly figures in results
          Object.keys(results).forEach(key => {
            if (key.includes('plotly_figure') && results[key].type === 'plotly_figure') {
              hasViz = true;

              // Create a div for this visualization
              const vizDiv = document.createElement('div');
              vizDiv.className = 'mb-4 p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 relative z-10';
              vizDiv.style.animation = 'fadeInUp 0.4s ease-out';
              vizDiv.id = 'plot_' + Math.random().toString(36).substr(2, 9);

              // Add title with icon
              const title = document.createElement('div');
              title.className = 'flex items-center text-sm font-medium mb-3 text-gray-700 dark:text-gray-300';
              title.innerHTML = `
                <span class="card-header-icon mr-2">
                  <span class="material-symbols-outlined text-xs text-primary dark:text-blue-300">show_chart</span>
                </span>
                ${key.replace('plotly_figure_', '').replace(/_/g, ' ').toUpperCase()}
              `;
              vizDiv.appendChild(title);

              // Add plot container
              const plotDiv = document.createElement('div');
              plotDiv.id = vizDiv.id + '_plot';
              plotDiv.style.width = '100%';
              plotDiv.style.height = '400px';
              plotDiv.style.minHeight = '400px';
              vizDiv.appendChild(plotDiv);

              vizContainer.appendChild(vizDiv);

              // Render the Plotly figure
              try {
                const figData = JSON.parse(results[key].json);
                Plotly.newPlot(plotDiv.id, figData.data, figData.layout, {
                  responsive: true,
                  displayModeBar: true,
                  modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                  displaylogo: false
                });
              } catch (error) {
                console.error('Error rendering Plotly figure:', error);
                plotDiv.innerHTML = '<p class="text-red-500">Error rendering visualization</p>';
              }
            }
          });

          // Show visualizations container if we have any
          if (hasViz) {
            containers.visualizations.classList.remove('hidden');
          }
        }

        sendBtn.addEventListener('click', sendMessage);
        input.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
        });

        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            uploadFile(file);
          }
        });

        // Premium Input Enhancements
        const inputContainer = document.getElementById('input-container');

        // Auto-resize textarea
        input.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 128) + 'px'; // max 128px (max-h-32)

          // Toggle pulse animation on send button when content exists
          if (this.value.trim()) {
            sendBtn.classList.add('has-content');
          } else {
            sendBtn.classList.remove('has-content');
          }
        });

        // Focus/blur effects for input container
        input.addEventListener('focus', () => {
          inputContainer.classList.add('focused');
        });

        input.addEventListener('blur', () => {
          inputContainer.classList.remove('focused');
        });

        // Reset textarea height after sending
        const originalSendMessage = sendMessage;
        sendMessage = function() {
          originalSendMessage();
          input.style.height = 'auto';
          sendBtn.classList.remove('has-content');
        };

        // Load existing file info on page load
        fetch('/file-info')
          .then(response => response.json())
          .then(result => {
            if (result.status === 'success') {
              currentFile = result.file_info;
              updateFileInfo(currentFile);
            }
          })
          .catch(error => console.log('No existing file'));
      })();

        // Load existing rules on page load
        loadRules();

        // Rules management functions
        function loadRules() {
          fetch('/rules')
            .then(response => response.json())
            .then(result => {
              if (result.status === 'success') {
                displayRules(result.rules);
              }
            })
            .catch(error => console.error('Error loading rules:', error));
        }

        function displayRules(rules) {
          const container = document.getElementById('rulesContainer');

          if (rules.length === 0) {
            container.innerHTML = '<p class="text-center">No custom rules defined</p>';
            return;
          }

          container.innerHTML = rules.map(rule => `
            <div class="flex justify-between items-start p-2 bg-gray-100 dark:bg-gray-600 rounded mb-2 relative z-10">
              <div class="flex-1 mr-2">
                <p class="text-xs break-words">${rule.text}</p>
                <span class="text-xs text-gray-400">${rule.category}</span>
              </div>
              <button onclick="deleteRule(${rule.id})" class="ml-2 text-red-500 hover:text-red-700 flex-shrink-0 p-1 rounded hover:bg-red-100 dark:hover:bg-red-900 transition-colors">
                <span class="material-symbols-outlined text-sm">delete</span>
              </button>
            </div>
          `).join('');
        }

        function addRule() {
          const ruleText = prompt('Enter a new rule:');
          if (!ruleText || !ruleText.trim()) return;

          const category = prompt('Enter category (optional):', 'general') || 'general';

          fetch('/rules', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              text: ruleText.trim(),
              category: category.trim(),
              priority: 1
            })
          })
          .then(response => response.json())
          .then(result => {
            if (result.status === 'success') {
              loadRules(); // Reload rules
            } else {
              alert('Failed to add rule: ' + result.message);
            }
          })
          .catch(error => {
            console.error('Error adding rule:', error);
            alert('Failed to add rule');
          });
        }

        function deleteRule(ruleId) {
          if (!confirm('Are you sure you want to delete this rule?')) return;

          fetch(`/rules/${ruleId}`, {
            method: 'DELETE'
          })
          .then(response => response.json())
          .then(result => {
            if (result.status === 'success') {
              loadRules(); // Reload rules
            } else {
              alert('Failed to delete rule: ' + result.message);
            }
          })
          .catch(error => {
            console.error('Error deleting rule:', error);
            alert('Failed to delete rule');
          });
        }

        // Add event listener for add rule button
        document.getElementById('addRuleBtn').addEventListener('click', addRule);

        // Copy code to clipboard function
        function copyCodeToClipboard(button) {
          const codeBlock = button.closest('.code-block-container');
          const codeElement = codeBlock.querySelector('code');
          const code = codeElement.textContent;

          navigator.clipboard.writeText(code).then(() => {
            // Show feedback
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="material-symbols-outlined" style="font-size: 14px;">check</span>Copied!';
            button.style.background = '#059669';

            setTimeout(() => {
              button.innerHTML = originalText;
              button.style.background = '';
            }, 2000);
          }).catch(err => {
            console.error('Failed to copy code: ', err);
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = code;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);

            // Show feedback
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="material-symbols-outlined" style="font-size: 14px;">check</span>Copied!';
            button.style.background = '#059669';

            setTimeout(() => {
              button.innerHTML = originalText;
              button.style.background = '';
            }, 2000);
          });
        }

        // Make function globally available
        window.copyCodeToClipboard = copyCodeToClipboard;
    </script>

</body></html>

